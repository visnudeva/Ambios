<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Ambios</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --clr-bg:#111;
      --clr-accent:#20e3b2;
      --clr-text:#fff;
      --beat-scale:1;
      --hue:0;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial}
    html,body{height:100%;overflow:hidden;background:var(--clr-bg);color:var(--clr-text)}

    /* ---------- GLIDING BLOBS ---------- */
    /* Blobs are now absolutely positioned within #blobs-container */
    #blobs-container { /* New container for blobs to apply filter */
      position: absolute;
      inset: 0;
      filter: url(#plasma); /* Filter applied here */
      z-index: -1;
    }
    .blob{
      position:absolute;
      border-radius:50%;
      background:hsl(var(--hue) 100% 60%);
      transform:scale(var(--beat-scale));
      transition:transform .05s linear, background .3s linear;
    }
    .blob:nth-child(1){width:60vmin;height:60vmin;animation:glide1 120s linear infinite}
    .blob:nth-child(2){width:40vmin;height:40vmin;animation:glide2 100s linear infinite}
    .blob:nth-child(3){width:20vmin;height:20vmin;animation:glide3 90s linear infinite}
    @keyframes glide1{
      0%{left:-60%;top:10%}
      50%{left:110%;top:90%}
      100%{left:-60%;top:10%}
    }
    @keyframes glide2{
      0%{left:110%;top:-40%}
      50%{left:-40%;top:110%}
      100%{left:110%;top:-40%}
    }
    @keyframes glide3{
      0%{left:10%;top:110%}
      50%{left:90%;top:-20%}
      100%{left:10%;top:110%}
    }

    /* ---------- GLASS / RESPONSIVE ---------- */
    .glass{
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:1rem;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      padding:.75rem 1rem;
    }
    main{
      position:relative;
      z-index:1;
      display:flex;
      flex-direction:column;
      align-items:center; /* Centers horizontally */
      justify-content: center; /* Centers vertically */
      padding:2rem;
      height:100%;
      gap:1rem;
    }
    #searchWrap{
      width:clamp(240px,95vw,1000px);
      max-width:100%;
      position:relative; /* Added for absolute positioning of #blobs-container */
      overflow:hidden; /* Added to clip blobs outside this container */
      border-radius:1rem; /* Ensure searchWrap has rounded corners */
    }

    #nowBar{
      width:100%;
      margin-bottom:.75rem;
      display:flex;
      align-items:center;
      gap:.75rem;
      cursor:pointer; /* Added for clickability */
      justify-content: center; /* Center content */
      position: relative;
      overflow: hidden;
    }
    #nowBar span{
        flex:1 1 auto;
        text-align: center; /* Center the text */
        transition: transform 0.2s ease-out; /* Smooth transition for zoom */
    }
    #nowBar.zoomed span {
        transform: scale(0.9); /* Zoom out effect */
    }


    #search{width:100%;margin-bottom:.75rem;color:var(--clr-text);outline:none}

    #panes{display:flex;flex-direction:column;width:100%;gap:1rem} /* Changed to column direction */
    #results, #recent{flex:1 1 auto; display:flex;flex-direction:column;} /* Adjusted flex property */
    #results ul, #recent ul{
      list-style:none;
      margin:0;
      padding:0;
      width:100%;
      overflow-y:auto;
      min-height:calc(2.5rem * 5 + 0.5rem * 4); /* 5 rows * item_height + 4 gaps between items (0.5rem each) */
      max-height:calc(2.5rem * 5 + 0.5rem * 4); /* Set max-height to ensure scrollbar */
    }
    #results li,#recent li{display:flex;align-items:center;gap:.75rem;padding:.5rem .75rem;border-radius:.5rem;cursor:pointer;min-height:2.5rem}
    #results li:hover,#recent li:hover{background:rgba(255,255,255,0.08)}

    @media (max-width:600px){
      #panes{flex-direction:column}
      #blobs-container {
        filter: url(#plasma-mobile); /* Apply a different, lighter filter for mobile */
      }
      /* Make blobs slightly smaller on mobile to reduce GPU/CPU load */
      .blob:nth-child(1){width:40vmin;height:40vmin;}
      .blob:nth-child(2){width:20vmin;height:20vmin;}
      .blob:nth-child(3){width:10vmin;height:10vmin;}
    }

    #playBar{
      position:fixed;
      bottom:1.5rem;
      left:50%;
      translate:-50% 0;
      z-index:10;
      display:flex;
      align-items:center;
      gap:.75rem;
    }
  </style>
</head>
<body>
  <!-- SVG goo -->
  <svg width="0" height="0">
    <filter id="plasma">
      <feGaussianBlur stdDeviation="18"/>
      <feColorMatrix values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7"/>
    </filter>
    <!-- New filter for mobile to make the blobs lighter and less GPU intensive -->
    <filter id="plasma-mobile">
      <feGaussianBlur stdDeviation="0"/> <!-- Reduced blur for lighter GPU load -->
      <feColorMatrix values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 8 -2"/> <!-- Adjusted alpha values for a lighter effect -->
    </filter>
  </svg>

  <!-- UI -->
  <main>
    <div id="searchWrap">
      <!-- New container for drifting blobs -->
      <div id="blobs-container">
        <div class="blob"></div>
        <div class="blob"></div>
        <div class="blob"></div>
      </div>

      <div id="nowBar" class="glass">
        <span id="now">Choose a station</span>
      </div>

      <input id="search" class="glass" type="search" placeholder="Type a station nameâ€¦" autocomplete="off"/>

      <div id="panes">
        <div id="results" class="glass"><ul></ul></div>
        <div id="recent" class="glass"><ul></ul></div>
      </div>
    </div>

    <audio id="player" crossorigin></audio>
  </main>

  <script type="module">
    /* 1.  radio-browser helper */
    const API = 'https://de1.api.radio-browser.info/json/stations/search';
    async function searchStations(term, limit = 20){
      const res = await fetch(`${API}?name=${encodeURIComponent(term)}&limit=${limit}&hidebroken=true`,
                              {headers:{'User-Agent':'LavaRadio/1.0'}});
      return res.json();
    }

    /* 2.  nodes */
    const searchInp = document.getElementById('search');
    const resultsUl = document.querySelector('#results ul');
    const recentUl  = document.querySelector('#recent ul');
    const player    = document.getElementById('player');
    const nowText   = document.getElementById('now');
    const nowBar    = document.getElementById('nowBar'); // Get the nowBar element

    /* 3.  recent list (localStorage) */
    const MAX_RECENT = 10;
    let recent = JSON.parse(localStorage.getItem('lava-recent') || '[]');

    function saveRecent(station){
      recent = recent.filter(s => s.url !== station.url);
      recent.unshift(station);
      recent = recent.slice(0, MAX_RECENT);
      localStorage.setItem('lava-recent', JSON.stringify(recent));
      renderRecent();
    }

    function renderRecent(){
      recentUl.innerHTML='';
      // Ensure 5 list items are always rendered to maintain height, even if empty
      for (let i = 0; i < Math.max(5, recent.length); i++) {
        const li=document.createElement('li');
        li.style.minHeight='2.5rem'; // Ensure consistent height for each row
        if (recent[i]) {
          li.innerHTML=`<span>${recent[i].name}</span>`;
          li.onclick = ()=> select(recent[i]);
        } else {
            // Add a non-breaking space for empty rows to maintain height
            li.innerHTML=`<span>&nbsp;</span>`;
        }
        recentUl.appendChild(li);
      }
    }

    /* 4.  live search (no hiding) */
    let searchDebounce;
    searchInp.addEventListener('input', ()=>{
      clearTimeout(searchDebounce);
      searchDebounce = setTimeout(async ()=>{
        const term = searchInp.value.trim();
        if(term.length<2){ render([]); return; }
        const stations = await searchStations(term);
        render(stations);
      }, 300);
    });

    function render(list){
      resultsUl.innerHTML='';
      // Ensure 5 list items are always rendered to maintain height, even if empty
      for (let i = 0; i < Math.max(5, list.length); i++) {
        const li=document.createElement('li');
        li.style.minHeight='2.5rem';
        if (list[i]) {
          li.innerHTML=`<span>${list[i].name}</span>`;
          li.onclick = ()=> select(list[i]);
        } else {
            // Add a non-breaking space for empty rows to maintain height
            li.innerHTML=`<span>&nbsp;</span>`;
        }
        resultsUl.appendChild(li);
      }
    }

    /* 5.  station selection & play/pause */
    async function select(st){
      const stream = st.url_resolved || st.url;
      player.src = stream.startsWith('https') ? stream : 'https://stream.srg-ssr.ch/m/drs3/mp3_128';
      try {
        await player.play();
        nowText.textContent = `Now playing: ${st.name}`;
        saveRecent(st);
      } catch (e) {
        if (e.name === 'AbortError') {
          nowText.textContent = 'Playback aborted (e.g., by user or new selection).';
        } else if (e.name === 'NotSupportedError') {
          nowText.textContent = 'Playback error: Media format not supported or network issue.';
        } else {
          nowText.textContent = 'Playback error: ' + e.message;
        }
        console.error('Playback error:', e);
      }
    }

    // Play/Pause functionality for nowBar click
    nowBar.addEventListener('click', () => {
      if (player.paused) {
        player.play();
      } else {
        player.pause();
      }
      // Add and remove 'zoomed' class for visual effect
      nowBar.classList.add('zoomed');
      setTimeout(() => {
        nowBar.classList.remove('zoomed');
      }, 200); // Duration of the zoom-out transition
    });

    // Keyboard control for play/pause (spacebar)
    document.addEventListener('keydown', (event) => {
      if (event.code === 'Space') {
        event.preventDefault(); // Prevent scrolling the page
        if (player.paused) {
          player.play();
        } else {
          player.pause();
        }
        // Add and remove 'zoomed' class for visual effect
        nowBar.classList.add('zoomed');
        setTimeout(() => {
          nowBar.classList.remove('zoomed');
        }, 200); // Duration of the zoom-out transition
      }
    });

    /* 6.  beat-sync lava */
    const audioCtx = new (window.AudioContext||webkitAudioContext)();
    let analyser, dataArray;
    player.addEventListener('play', ()=>{
      if(analyser) return;
      const src = audioCtx.createMediaElementSource(player);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 256;
      src.connect(analyser);
      analyser.connect(audioCtx.destination);
      dataArray = new Uint8Array(analyser.frequencyBinCount);
      beatLoop();
    });
    function beatLoop(){
      analyser.getByteFrequencyData(dataArray);
      const volume = dataArray.reduce((a,b)=>a+b)/dataArray.length;
      const scale  = 1 + volume/256;
      document.documentElement.style.setProperty('--beat-scale', scale.toFixed(3));
      requestAnimationFrame(beatLoop);
    }

    /* 7.  color cycle */
    let hue=0;
    setInterval(()=>{
      hue = (hue + 0.5) % 360;
      document.documentElement.style.setProperty('--hue', hue);
    }, 50);

    /* init */
    renderRecent();
    render([]);
  </script>
</body>
</html>
