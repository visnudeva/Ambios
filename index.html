<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Lava Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root{
      --clr-bg:#111;
      --clr-accent:#20e3b2;
      --clr-text:#fff;
      --beat-scale:1;
      --hue:0;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,Arial}
    html,body{height:100%;overflow:hidden;background:var(--clr-bg);color:var(--clr-text)}

    /* ---------- GLIDING BLOBS ---------- */
    #blobs{position:fixed;inset:0;filter:url(#plasma);z-index:0}
    .blob{
      position:absolute;
      border-radius:50%;
      background:hsl(var(--hue) 100% 60%);
      transform:scale(var(--beat-scale));
      transition:transform .05s linear, background .3s linear;
    }
    .blob:nth-child(1){width:60vmin;height:60vmin;animation:glide1 120s linear infinite}
    .blob:nth-child(2){width:40vmin;height:40vmin;animation:glide2 100s linear infinite}
    .blob:nth-child(3){width:20vmin;height:20vmin;animation:glide3 90s linear infinite}
    @keyframes glide1{
      0%{left:-60%;top:10%}
      50%{left:110%;top:90%}
      100%{left:-60%;top:10%}
    }
    @keyframes glide2{
      0%{left:110%;top:-40%}
      50%{left:-40%;top:110%}
      100%{left:110%;top:-40%}
    }
    @keyframes glide3{
      0%{left:10%;top:110%}
      50%{left:90%;top:-20%}
      100%{left:10%;top:110%}
    }

    /* ---------- GLASS / RESPONSIVE ---------- */
    .glass{
      background:rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:1rem;
      backdrop-filter:blur(12px);
      -webkit-backdrop-filter:blur(12px);
      padding:.75rem 1rem;
    }
    main{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;padding:2rem;height:100%;gap:1rem}

    /* now playing bar (full width) */
    #nowBar{
      width:clamp(240px,95vw,1000px);
      max-width:100%;
      display:flex;
      align-items:center;
      gap:.5rem;
    }
    #nowBar > span{flex:1;font-weight:600}
    /* flat circle buttons */
    .btn{
      width:2.5rem;
      height:2.5rem;
      border:none;
      border-radius:50%;
      background:var(--clr-accent);
      color:#111;
      font-size:1.2rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* search bar full width + space below */
    #search{
      width:100%;
      margin-bottom:.75rem;
      color:var(--clr-text);
      outline:none;
    }

    /* dual pane layout */
    #panes{
      display:flex;
      width:clamp(240px,95vw,1000px);
      max-width:100%;
      gap:1rem;
    }
    #results,
    #recent{
      flex:1 1 0;
      display:flex;
      flex-direction:column;
    }
    #results ul,
    #recent ul{
      list-style:none;
      margin:0;
      padding:0;
      width:100%;
      max-height:calc(2.5rem * 5 + 1rem); /* 5 visible items */
      overflow-y:auto;
    }
    #results li,
    #recent li{
      display:flex;
      align-items:center;
      gap:.75rem;
      padding:.5rem .75rem;
      border-radius:.5rem;
      cursor:pointer;
      min-height:2.5rem;
    }
    #results li:hover,
    #recent li:hover{background:rgba(255,255,255,0.08)}
    #results li img,
    #recent li img{width:32px;height:32px;border-radius:4px;object-fit:cover}

    @media (max-width:600px){
      #panes{flex-direction:column}
    }
  </style>
</head>
<body>
  <!-- SVG goo -->
  <svg width="0" height="0">
    <filter id="plasma">
      <feGaussianBlur stdDeviation="18"/>
      <feColorMatrix values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 18 -7"/>
    </svg>

  <!-- drifting blobs -->
  <div id="blobs">
    <div class="blob"></div>
    <div class="blob"></div>
    <div class="blob"></div>
  </div>

  <!-- UI -->
  <main>
    <!-- Now-Playing bar (always visible) -->
    <div id="nowBar" class="glass">
      <span id="now">Choose a station</span>
      <button id="toggleBtn" class="btn" title="Play / Pause">‚ñ∂</button>
      <button id="fsBtn" class="btn" title="Full screen">‚õ∂</button>
      <button id="hideBtn" class="btn" title="Hide/Show panels">üëÅ</button>
    </div>

    <!-- content that can be hidden -->
    <div id="contentToHide">
      <input id="search" class="glass" type="search" placeholder="Type a station name‚Ä¶" autocomplete="off"/>
      <div id="panes">
        <!-- Search results (left) -->
        <div id="results" class="glass">
          <ul></ul>
        </div>

        <!-- Recent list (right) -->
        <div id="recent" class="glass">
          <ul>
            <li style="pointer-events:none;font-weight:600;color:var(--clr-accent);min-height:2.5rem;">Recent</li>
          </ul>
        </div>
      </div>
    </div>

    <audio id="player" crossorigin></audio>
  </main>

  <script type="module">
  /* ===== mobile detection ===== */
  const isMobile = window.innerWidth <= 600 || navigator.maxTouchPoints > 0;

  /* ===== mobile-optimised constants ===== */
  const FFT_SIZE  = isMobile ? 256 : 2048;   // smaller FFT
  const BEAT_FPS  = isMobile ? 30 : 60;      // 30 FPS for mobile
  const DPR_SCALE = isMobile ? 0.5 : 1;      // lower canvas resolution

  /* ===== radio-browser helper ===== */
  const API = 'https://de1.api.radio-browser.info/json/stations/search';
  async function searchStations(term, limit = 20){
    const res = await fetch(`${API}?name=${encodeURIComponent(term)}&limit=${limit}&hidebroken=true`,{headers:{'User-Agent':'LavaRadio/1.0'}});
    return res.json();
  }

  /* ===== nodes ===== */
  const searchInp = document.getElementById('search');
  const resultsUl = document.querySelector('#contentToHide #results ul');
  const recentUl  = document.querySelector('#contentToHide #recent ul');
  const player    = document.getElementById('player');
  const nowText   = document.getElementById('now');
  const toggleBtn = document.getElementById('toggleBtn');
  const fsBtn     = document.getElementById('fsBtn');
  const hideBtn   = document.getElementById('hideBtn');
  const content   = document.getElementById('contentToHide');

  /* ===== recent list (localStorage) ===== */
  const MAX_RECENT = 10;
  let recent = JSON.parse(localStorage.getItem('lava-recent') || '[]');
  function saveRecent(station){
    recent = recent.filter(s => s.url !== station.url);
    recent.unshift(station);
    recent = recent.slice(0, MAX_RECENT);
    localStorage.setItem('lava-recent', JSON.stringify(recent));
    renderRecent();
  }
  function renderRecent(){
    while(recentUl.children.length > 1) recentUl.removeChild(recentUl.lastChild);
    recent.forEach(st => {
      const li=document.createElement('li');
      li.innerHTML=`<img loading="lazy" src="${st.favicon||''}" alt="" onerror="this.style.display='none';"/><span>${st.name}</span>`;
      li.onclick = ()=> select(st);
      recentUl.appendChild(li);
    });
  }

  /* ===== hide/show panels ===== */
  function togglePanels(){
    const hidden = content.style.opacity==='0';
    content.style.opacity = hidden ? '1' : '0';
  }
  hideBtn.addEventListener('click', togglePanels);

  /* ===== live search ===== */
  function render(list){
    resultsUl.innerHTML='';
    for (let i = 0; i < 10; i++) {
      const li=document.createElement('li');
      li.style.minHeight='2.5rem';
      if (list[i]) {
        li.innerHTML=`<img loading="lazy" src="${list[i].favicon||''}" alt="" onerror="this.style.display='none';"/><span>${list[i].name}</span>`;
        li.onclick = ()=> select(list[i]);
      }
      resultsUl.appendChild(li);
    }
  }

  /* ===== station selection ===== */
  async function select(st){
    const stream = st.url_resolved || st.url;
    player.src = stream.startsWith('https') ? stream : 'https://stream.srg-ssr.ch/m/drs3/mp3_128';
    player.play()
      .then(()=>{ nowText.textContent = `Now playing: ${st.name}`; saveRecent(st); })
      .catch(e=> nowText.textContent = 'Playback error: ' + e.message);
  }
  toggleBtn.addEventListener('click', ()=>{
    if(player.paused){ player.play(); toggleBtn.textContent='‚è∏'; }
    else{ player.pause(); toggleBtn.textContent='‚ñ∂'; }
  });
  player.addEventListener('pause', ()=> toggleBtn.textContent='‚ñ∂');
  player.addEventListener('play',  ()=> toggleBtn.textContent='‚è∏');

  /* ===== beat-sync lava (mobile-optimised) ===== */
  let analyser;
  const audioCtx = new (window.AudioContext||webkitAudioContext)();
  const BEAT_INTERVAL = 1000 / (isMobile ? 30 : 60); // throttled FPS
  let DATA_ARRAY;                                    // reused buffer
  player.addEventListener('play', ()=>{
    if(analyser) return;
    const src = audioCtx.createMediaElementSource(player);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = FFT_SIZE;                     // 256 on mobile, 2048 on desktop
    src.connect(analyser);
    analyser.connect(audioCtx.destination);
    DATA_ARRAY = new Uint8Array(analyser.frequencyBinCount);
    beatLoop();
  });
  function beatLoop(){
    if(!analyser) return;
    analyser.getByteFrequencyData(DATA_ARRAY);
    const volume = DATA_ARRAY.reduce((a,b)=>a+b)/DATA_ARRAY.length;
    const scale = 1 + volume / (isMobile ? 120 : 256);
    document.documentElement.style.setProperty('--beat-scale', scale.toFixed(2));
    setTimeout(()=> requestAnimationFrame(beatLoop), BEAT_INTERVAL);
  }

  /* ===== color cycle ===== */
  let hue=0;
  setInterval(()=>{ hue=(hue+0.5)%360; document.documentElement.style.setProperty('--hue',hue); },50);

  /* ===== full-screen toggle ===== */
  fsBtn.addEventListener('click', ()=>{
    if(!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  });

  /* init */
  renderRecent();
  render([]);
</script>
</body>
</html>
